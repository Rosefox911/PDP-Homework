;; The first three lines of this file were inserted by DrRacket. They record metadata
;; about the language level of this file in a form that our tools can easily process.
#reader(lib "htdp-beginner-reader.ss" "lang")((modname rectangle) (read-case-sensitive #t) (teachpacks ()) (htdp-settings #(#t constructor repeating-decimal #f #t none #f ())))
(require 2htdp/universe)
(require 2htdp/image)
(require rackunit)
(require rackunit/text-ui)
(require "extras.rkt")

;; run with (run 0)

;;(provide run)
;;(provide initial-world)
;;(provide world-to-center)

;; DATA DEFINITIONS

(define-struct world
  (coordinates world-selected? circle-offset))
;; A World is a (make-world Posn Boolean Posn)
;; Interpretation:
;; coordinates is the posn that holds 
;; the x and y coordinates in the middle of the rectangle
;; world-selected? determines whether 
;; or not the rectangle is selected.
;; circle-offset is the posn that holds the the x coordinate
;; offset from rectangle's x coordinate to the 
;; INDICATOR circle's x coordinate and
;; the y coordinate offset from rectangle's y coordinate
;; to the INDICATOR circle's y coordinate.

;; template:
;; world-fn : World -> ??
;(define (world-fn w)
;  (...
;   (world-coordinates w)
;   (world-y-pos w)
;   (world-world-selected? w)
;   (world-circle-offset w)))

;; template:
;; posn-fn : Posn -> ??
;(define (posn-fn po)
;  (...
;   (posn-x posn)
;   (posn-y posn)))

;; A DraggableRectangleMouseEvent is a partition of 
;; MouseEvent into the following categories:
;; -- "button-down" (interp: maybe select the rectangle)
;; -- "drag" (interp: maybe drag the rectangle)
;; -- "button-up" (interp: unselect the rectangle)
;; -- any other mouse event (interp: ignored)

;(define (mev-fn mev)
;  (cond
;    [(mouse=? mev "button-down") ...]
;    [(mouse=? mev "drag") ...]
;    [(mouse=? mev "button-up") ...]
;    [else ...]))

;; END OF DATA DEFINITIONS

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; CONSTANTS
(define RECTANGLE-DRAWING (rectangle 100 60 "solid" "green"))
;; defines the size and color 
;; of the rectangle when it is NOT selected.

(define SELECTED-RECTANGLE-DRAWING (rectangle 100 60 "outline" "green"))
;; defines the size and color 
;; of the rectangle when it IS selected.

(define INDICATOR (circle 5 "solid" "red"))
;; defines the size and color of the indicator circle.
;; Used to indicate where the mouse grabbed the rectangle.

(define CANVAS-WIDTH 400)
;; defines the width of the canvas (scene) 
;; upon which we will place the rectangle.

(define CANVAS-HEIGHT 300)
;; defines the height of the canvas (scene) 
;; upon which we will place the rectangle.

(define EMPTY-CANVAS (empty-scene CANVAS-WIDTH CANVAS-HEIGHT))
;; creates an empty-scene with the 
;; CANVAS-WIDTH and CANVAS-HEIGHT constants

(define HALF-RECTANGLE-WIDTH (/ 100 2))
;; defines half of the width dimension for the rectangle.

(define HALF-RECTANGLE-HEIGHT (/ 60 2))
;; defines half of the height dimension for the rectangle.

(define INITIAL-X 200)
;; defines the initial x coordinate of the rectangle on the canvas.

(define INITIAL-Y 150)
;; defines the initial y coordinate of the rectangle on the canvas.




;; END OF CONSTANTS

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; run : Any -> World
;; GIVEN: any value
;; EFFECT: ignores its argument and starts the interactive program.
;; RETURNS: the final state of the world.

;; initial-world : Any -> World
;; GIVEN: any value
;; RETURNS: the initial world.
;; Ignores its argument.

(define (run any)
  (big-bang (make-world (make-posn INITIAL-X INITIAL-Y) false (make-posn 0 0))
            (on-draw world-to-scene)
            (on-mouse world-after-mouse-event)))

;; world-to-scene : World -> Scene
;; RETURNS: a scene that portrays the given world
;; EXAMPLES:
;; TODO
;; STRATEGY: STRUCTURAL DECOMPOSITION on world : World

(define (world-to-scene world)
  (if (equal? (world-selected? world) false) 
      (draw-unselected (world-coordinates world)) 
      (draw-selected (world-coordinates world) (world-circle-offset world))))


;; TESTS
;; TODO


;; draw-selected : Posn Posn -> Scene
;; GIVEN: a posn representing the coordinates
;; of the middle of a rectangle and a posn representing
;; the offset of the INDICATOR circle from this point.
;; RETURNS: a scene that portrays the world
;; EXAMPLES:
;; TODO
;; STRATEGY: STRUCTURAL DECOMPOSITION on posn : Posn

(define (draw-selected rectangleposn indicatorposn)
  (place-image SELECTED-RECTANGLE-DRAWING 
               (posn-x rectangleposn) 
               (posn-y rectangleposn)
  (place-image INDICATOR
               (- (posn-x indicatorposn) 
                  (posn-x rectangleposn))
               (- (posn-y indicatorposn) 
                  (posn-y rectangleposn)) EMPTY-CANVAS)))

;; TESTS
;; TODO


;(define (world-fn w)
;  (...
;   (world-coordinates w)
;   (world-y-pos w)
;   (world-world-selected? w)
;   (world-circle-offset w)))



;; draw-unselected : Posn -> Scene
;; GIVEN: a posn representing the coordinates 
;; of the middle of the rectangle
;; Returns: a scene that portrays the world
;; EXAMPLES:
;; TODO
;; STRATEGY: STRUCTURAL DECOMPOSITION on posn : Posn
(define (draw-unselected posn)
  (place-image RECTANGLE-DRAWING 
               (posn-x posn) 
               (posn-y posn) EMPTY-CANVAS))

;; TESTS
;; TODO

;; world-to-center : World -> Posn
;; GIVEN: a world
;; RETURNS: the coordinates of the center of the rectangle as a Posn
;; EXAMPLES:
;; (world-to-center (make-world 120 120 true)) -> (make-posn 120 120)
;; (world-to-center (make-world 140 140 false)) -> (make-posn 140 140)
;; STRATEGY: Structural Decomposition on world : World
  
(define (world-to-center world)
  (make-posn 
   (posn-x (world-coordinates world))
   (posn-y (world-coordinates world))))

;; TESTS
;; TODO

;; world-selected? : World -> Boolean
;; GIVEN a world
;; RETURNS: true iff the rectangle is selected.
;; EXAMPLES:
;; (world-selected? (make-world 120 120 true)) -> true
;; (world-selected? (make-world 120 120 false)) -> true
;; STRATEGY: STRUCTURCAL DECOMPOSITION on world : World

(define (world-selected? world)
  (world-world-selected? world))

;; TESTS
;; TODO

;; world-after-mouse-event : World Number Number MouseEvent -> World
;; GIVEN: a world, a number representing 
;; the x coordinate of the proposed world 
;; a number representing the y coordinate of the 
;; proposed world, and a mousevent.
;; RETURNS: the world that follows the given mouseevent.
;; EXAMPLES:
;; TODO
;; STRATEGY: STRUCTURAL DECOMPOSITION on mouseevent : MouseEvent

(define (world-after-mouse-event world x y mouseevent)
  (cond
    [(mouse=? mouseevent "button-down") 
     (world-after-button-down world x y)]
    [(mouse=? mouseevent "drag") 
     (world-after-drag world x y)]
    [(mouse=? mouseevent "button-up") 
     (world-after-button-up world x y)]
    [else world]))

;; TESTS
;; TODO


;; world-after-button-down : World Number Number -> World
;; GIVEN: a world, a number representing 
;; the x coordinate of the proposed world 
;; a number representing the y coordinate of the proposed world.
;; RETURNS: The world that follows a button-down mouseevent 
;; at a given location.
;; if the button-down event is inside the rectangle, 
;; returns a world that is now selected which 
;; has the offset of circle-x-offset and circle-y-offset calculated.
;; EXAMPLES:
;; TODO
;; STRATEGY: Structural Decomposition on world : World
(define (world-after-button-down world x y)
  (if (inside-rectangle? world x y) 
      (make-world (make-posn 
                   (posn-x (world-coordinates world)) 
                   (posn-y (world-coordinates world))) 
                  true 
                  (calc-offset x y (world-coordinates world))) world))

;; TESTS
;; TODO


;; calc-offset : Number Number Posn -> Posn
;; GIVEN: a number representing the x coordinate 
;; of the proposed world. A number representing the y coordinate
;; of the proposed world. A posn representing the
;; current position of the middle of the rectangle on the canvas.
;; RETURNS: a posn representing the offset of the 
;; INDICATOR circle from the midde of the rectangle
;; EXAMPLES:
;; STRATEGY: Structural Decomposition on posn : Posn


(define (calc-offset x y posn)
  (make-posn
   (+ (posn-x posn) x)
   (+ (posn-y posn) y)))



;; world-after-drag : World Number Number -> World
;; GIVEN: a world, a number representing
;; the x coordinate of the proposed world
;; a number representing the y coordinate of the proposed world.
;; RETURNS: The world that follows a drag mouseevent.
;; If the world is selected, 
;; then return a world just like the given one,
;; except that is now centered on the mouse position
;; EXAMPLES:
;; TODO
;; STRATEGY: STRUCTURAL DECOMPOSITION on world : World

(define (world-after-drag world x y)
  (if (world-selected? world) (make-world 
                               (fix-coordinates (make-posn x y)) 
                               (world-world-selected? world) 
                               (world-circle-offset world)) world))

;; TEST
;; TODO

;; fix-coordinates : Posn -> Posn
;; GIVEN: a Posn
;; RETURNS: a Posn
;; EXAMPLES:
;; TODO
;; STRATEGY: Structural Decomposition on posn : Posn

(define (fix-coordinates posn)
  (make-posn
   [cond
     [(< (posn-x posn) 50) 50]
     [(> (posn-x posn) 350) 350]
     [else (posn-x posn)]]
   [cond
     [(< (posn-y posn) 30) 30]
     [(> (posn-y posn) 270) 270]
     [else (posn-y posn)]]))


;; world-after-button-up : World Number Number -> World
;; GIVEN: a world, a number representing 
;; the x coordinate of the proposed world
;; a number representing the y coordinate of the proposed world.
;; RETURNS: The world that follows a drag mouseevent.
;; If the world is selected, 
;; then return a world just like the given one,
;; except that it is no longer selected.
;; the circle-x-offset and circle-y-offset will be reset to 0
;; EXAMPLES:
;; TODO
;; STRATEGY: Structural Decomposition on world : World

(define (world-after-button-up world x y)
  (if (world-selected? world) 
      (make-world (make-posn 
                   (posn-x (world-coordinates world)) 
                   (posn-y (world-coordinates world))) 
                    false 
                    (make-posn 0 0)) world))



;; TESTS
;; TODO

;; inside-rectangle? : World Number Number -> Boolean
;; GIVEN: a world, a number representing the x coordinate,
;; and a number representing the y coordinate.
;; RETURNS: true iff the given coordinate is inside 
;; the bounding box of the rectangle.
;; EXAMPLES:
;; (inside-rectangle? (make-world 200 200 false) 150 150) -> false
;; (inside-rectangle? (make-world 100 60 false) 150 150) -> false
;; (inside-rectangle? (make-world 100 60 false) 150 90) -> true
;; (inside-rectangle? (make-world 100 60 false) 140 70) -> true
;; STRATEGY: STRUCTURAL DECOMPOSITION on world: World

(define (inside-rectangle? world x y)
  (and
    (<= 
      (- (posn-x (world-coordinates world)) HALF-RECTANGLE-WIDTH)
      x
      (+ (posn-x (world-coordinates world)) HALF-RECTANGLE-WIDTH))
    (<= 
      (- (posn-y (world-coordinates world)) HALF-RECTANGLE-HEIGHT)
      y
      (+ (posn-y (world-coordinates world)) HALF-RECTANGLE-HEIGHT))))

;; TESTS
;; TODO